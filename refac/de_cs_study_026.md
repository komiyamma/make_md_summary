# ç¬¬26ç«  è¦³æ¸¬ï¼ˆã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ï¼‰æœ€å°ã‚»ãƒƒãƒˆğŸ”­âœ¨

## ã­ã‚‰ã„ğŸ¯

ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã¾ã‚ã‚Šã§ã€Œã‚ã¨ã§è¿½ãˆã‚‹ã€ã‚’ä½œã‚Šã¾ã™ğŸ™‚ğŸ”
ã¤ã¾ã‚Šâ€¦**ã€Œã„ã¤ã€ã€Œä½•ãŒã€ã€Œã©ã®æ³¨æ–‡ã§ã€ã€Œã©ã®å‡¦ç†ã®æµã‚Œã§ã€ã€ŒæˆåŠŸ/å¤±æ•—ã—ãŸã‹ã€**ãŒã€ãƒ­ã‚°ã‚„è¨ˆæ¸¬ã§è¾¿ã‚Œã‚‹çŠ¶æ…‹ã«ã—ã¾ã™ğŸ§µâœ¨

---

## ã¾ãšè¶…ã–ã£ãã‚Šï¼šã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ã£ã¦ä½•ï¼ŸğŸ§ âœ¨

ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ï¼ˆObservabilityï¼‰ã¯ã€ã–ã£ãã‚Šè¨€ã†ã¨ **â€œä¸­ã§ä½•ãŒèµ·ãã¦ã‚‹ã‹å¤–ã‹ã‚‰åˆ†ã‹ã‚‹åŠ›â€** ã§ã™ğŸ‘€ğŸ”­
ä»£è¡¨çš„ãª3æœ¬æŸ±ã¯ã“ã‚ŒğŸ‘‡

* **Logsï¼ˆãƒ­ã‚°ï¼‰** ğŸ§¾ï¼šå‡ºæ¥äº‹ã®è¨˜éŒ²ï¼ˆæ–‡ç« ï¼‹é …ç›®ï¼‰
* **Tracesï¼ˆãƒˆãƒ¬ãƒ¼ã‚¹ï¼‰** ğŸ§µï¼šä¸€é€£ã®å‡¦ç†ã®æµã‚Œã‚’1æœ¬ã®ç³¸ã§è¿½ã†
* **Metricsï¼ˆãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼‰** ğŸ“ˆï¼šæ•°å€¤ã§å¥åº·çŠ¶æ…‹ã‚’è¦‹ã‚‹ï¼ˆå›æ•°ãƒ»æ™‚é–“ãƒ»å¤±æ•—ç‡ï¼‰

ã“ã®ç« ã§ã¯ã€æœ€å°ã‚»ãƒƒãƒˆã¨ã—ã¦ **ãƒ­ã‚°ä¸­å¿ƒï¼‹ç›¸é–¢IDï¼‹æœ€ä½é™ã®è¨ˆæ¸¬** ã¾ã§ä½œã‚Šã¾ã™ğŸ§©âœ¨
ï¼ˆ.NET ã¯ `ILogger` ã§é«˜æ€§èƒ½ãªæ§‹é€ åŒ–ãƒ­ã‚°ãŒæ‰±ãˆã¾ã™ğŸ§¾âœ¨ï¼‰([Microsoft Learn][1])

---

## ãªãœãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã«è¦³æ¸¬ãŒå¿…è¦ï¼ŸğŸ¤”ğŸ’¡

ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€Œèµ·ããŸäº‹å®Ÿã€ã‚’è¤‡æ•°ã®ãƒãƒ³ãƒ‰ãƒ©ã¸é…ã‚Šã¾ã™ğŸ””â¡ï¸ğŸ¯
ä¾¿åˆ©ã ã‘ã©ã€è¦³æ¸¬ãŒå¼±ã„ã¨ã“ã‚“ãªäº‹æ•…ãŒèµ·ããŒã¡ğŸ‘‡ğŸ˜µâ€ğŸ’«

* ã€Œãƒ¡ãƒ¼ãƒ«é€ä¿¡ã ã‘å¤±æ•—ã—ãŸã®ã«æ°—ã¥ã‹ãªã„ã€ğŸ“§ğŸ’¥
* ã€Œã©ã®æ³¨æ–‡ã®å‡¦ç†ãŒè©°ã¾ã£ã¦ã‚‹ã‹åˆ†ã‹ã‚‰ãªã„ã€ğŸ›’ğŸŒ€
* ã€ŒåŒã˜ã‚¤ãƒ™ãƒ³ãƒˆãŒäºŒé‡ã§å‡¦ç†ã•ã‚ŒãŸï¼Ÿã€ğŸ”ğŸ˜±
* ã€Œå¤±æ•—ãƒ­ã‚°ã¯ã‚ã‚‹ã‘ã©ã€æˆåŠŸã—ãŸè¨¼æ‹ ãŒãªã„ã€âœ…â“

ã ã‹ã‚‰ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ã¯ã“ã‚ŒğŸ‘‡âœ¨
**â€œã‚¤ãƒ™ãƒ³ãƒˆå˜ä½ã§ã€é–‹å§‹ãƒ»çµ‚äº†ãƒ»çµæœãƒ»æ™‚é–“ãƒ»ã¤ãªãŒã‚Šâ€ ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹** çŠ¶æ…‹ğŸ§¾ğŸ§µâ±ï¸

---

## æœ€å°ã‚»ãƒƒãƒˆã®è¨­è¨ˆå›³ğŸ—ºï¸âœ¨

ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡ï¼ˆDispatcherï¼‰ãŒã€æœ€ä½é™ã“ã‚Œã‚’æ®‹ã—ã¾ã™ğŸ‘‡

1. **ã‚¤ãƒ™ãƒ³ãƒˆãŒé…ä¿¡ã•ã‚ŒãŸ**ï¼ˆã„ã¤/ã©ã‚Œ/ã©ã®é›†ç´„IDï¼‰ğŸ””ğŸ§¾
2. **ã©ã®ãƒãƒ³ãƒ‰ãƒ©ãŒå‹•ã„ãŸ**ï¼ˆé–‹å§‹/çµ‚äº†ï¼‰ğŸ¯â±ï¸
3. **çµæœ**ï¼ˆæˆåŠŸâœ… / å¤±æ•—âŒ ã¨ç†ç”±ï¼‰ğŸ§¯
4. **ç›¸é–¢ID**ï¼ˆã“ã®ä¸€é€£ã®å‡¦ç†ã®â€œå…±é€šã®ç³¸â€ï¼‰ğŸ§µ
5. **å‡¦ç†æ™‚é–“**ï¼ˆé…ã„ã‚’æ¤œçŸ¥ã§ãã‚‹ï¼‰ğŸ¢âš¡

---

## ãƒ­ã‚°ã®ã€Œãƒ†ãƒ³ãƒ—ãƒ¬é …ç›®ã€ğŸ“‹âœ¨ï¼ˆã“ã‚Œã ã‘æƒãˆã‚Œã°å¼·ã„ï¼‰

ã¾ãšã¯ãƒ­ã‚°ã‚’â€œæ–‡ç« ã ã‘â€ã«ã›ãšã€**é …ç›®ï¼ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰**ã‚’æƒãˆã¾ã™ğŸ§¾â¡ï¸ğŸ§©
`ILogger` ã¯æ§‹é€ åŒ–ãƒ­ã‚°ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ï¼‹å€¤ï¼‰ã‚’æƒ³å®šã—ã¦ã¾ã™ğŸ™‚âœ¨([Microsoft Learn][1])

| é …ç›®å                    | ä¾‹                   | ä½•ã®ãŸã‚ï¼ŸğŸ™‚         |
| ---------------------- | ------------------- | --------------- |
| `event_name`           | `OrderPaid`         | ä½•ãŒèµ·ããŸï¼ŸğŸ””        |
| `aggregate_type`       | `Order`             | ã©ã®ç¨®é¡ï¼ŸğŸ§º         |
| `aggregate_id`         | `order-123`         | ã©ã‚Œã®è©±ï¼ŸğŸªª         |
| `handler`              | `GrantPointHandler` | èª°ãŒå‡¦ç†ï¼ŸğŸ¯         |
| `result`               | `success` / `fail`  | æˆå¦ã‚’ä¸€ç™ºã§âœ…âŒ        |
| `duration_ms`          | `42`                | é…ã„ã®æ¤œçŸ¥â±ï¸         |
| `correlation_id`       | `...`               | ä¸€é€£ã®æµã‚Œã§æŸã­ã‚‹ğŸ§µ     |
| `trace_id` / `span_id` | `...`               | ãƒ­ã‚°â‡„ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ç´ã¥ã‘ğŸ§µğŸ”— |
| `error_type`           | `Transient`         | ãƒªãƒˆãƒ©ã‚¤åˆ¤æ–­ğŸ”        |
| `exception`            | `TimeoutException`  | åŸå› ã®å…¥å£ğŸ§¯         |

> âœ…ãƒã‚¤ãƒ³ãƒˆï¼š**æˆåŠŸãƒ­ã‚°ã‚‚æ®‹ã™**
> å¤±æ•—ã ã‘ã ã¨ã€ŒæˆåŠŸã—ã¦ã„ã‚‹ã¯ãšãªã®ã«è¦‹ã¤ã‹ã‚‰ãªã„â€¦ã€ãŒèµ·ãã¾ã™ğŸ™‚ğŸŒ€

---

## ç›¸é–¢IDï¼ˆCorrelation IDï¼‰ã£ã¦ãªã«ï¼ŸğŸ§µâœ¨

ç›¸é–¢IDã¯ã€Œã“ã®ä¸€é€£ã®å‡¦ç†ã¯åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã ã‚ˆã€œã€ã£ã¦æŸã­ã‚‹IDã§ã™ğŸ§µ
ä¾‹ï¼š**æ³¨æ–‡ç¢ºå®šâ†’æ”¯æ‰•ã„â†’ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡â†’ãƒã‚¤ãƒ³ãƒˆä»˜ä¸â†’ãƒ¡ãƒ¼ãƒ«é€ä¿¡** ã‚’1æœ¬ã®ç³¸ã§è¿½ã†æ„Ÿã˜ğŸ™‚âœ¨

ã•ã‚‰ã«å¼·ã„ã®ãŒ **TraceId/SpanId** ã§ã™ğŸ§µğŸ”
.NET ã¯åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚¹ã§ **W3C TraceContext** ã‚’ä½¿ã„ã€`Activity.TraceId`ï¼ˆãƒˆãƒ¬ãƒ¼ã‚¹å…¨ä½“ã®IDï¼‰ã¨ `Activity.SpanId`ï¼ˆåŒºé–“ã®IDï¼‰ã§æµã‚Œã‚’è¡¨ã›ã¾ã™ğŸ§µâœ¨([Microsoft Learn][2])
OpenTelemetryã§ã‚‚ãƒ­ã‚°ã¨ãƒˆãƒ¬ãƒ¼ã‚¹ã¯ `TraceId` / `SpanId` ã§ç›¸é–¢ã§ãã¾ã™ğŸ§¾ğŸ”—ğŸ§µ([OpenTelemetry][3])

> ğŸ€ã“ã®æ•™æã®æœ€å°æ–¹é‡
>
> * ã¾ãšã¯ `correlation_id` ã‚’1ã¤ä»˜ã‘ã‚‹ğŸ§µ
> * ã§ãã‚Œã° `Activity`ï¼ˆTraceId/SpanIdï¼‰ã‚‚ä»˜ã‘ã‚‹ğŸ§µâœ¨

---

## å®Ÿè£…ã®ã‚³ã‚¢ï¼šBeginScopeã§â€œå…±é€šé …ç›®â€ã‚’è‡ªå‹•ã§ä»˜ã‘ã‚‹ğŸ§¾ğŸ§·

`ILogger.BeginScope()` ã‚’ä½¿ã†ã¨ã€ã‚¹ã‚³ãƒ¼ãƒ—å†…ã®ãƒ­ã‚°ã« **åŒã˜é …ç›®**ã‚’è‡ªå‹•ã§ä»˜ã‘ã‚‰ã‚Œã¾ã™âœ¨
ç›¸é–¢IDã‚„æ³¨æ–‡IDã‚’ä»˜ã‘ã‚‹ã®ã«è¶…ä¾¿åˆ©ğŸ™‚ğŸ§µ
ï¼ˆ`BeginScope` ã¯ã“ã†ã„ã†ç›¸é–¢æƒ…å ±ã‚’ä»˜ã‘ã‚‹ãŸã‚ã®åŸºæœ¬æ‰‹æ®µã¨ã—ã¦èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ï¼‰([nblumhardt.com][4])

---

## ä¾‹é¡Œï¼šã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡ã§ã€Œé–‹å§‹â†’æˆåŠŸ/å¤±æ•—â†’æ™‚é–“ã€ã‚’æ®‹ã™ğŸ› ï¸ğŸ””

### 1) ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã¨ãƒãƒ³ãƒ‰ãƒ©ï¼ˆæœ€å°ï¼‰ğŸ§©

```csharp
public interface IDomainEvent
{
    DateTimeOffset OccurredAt { get; }
}

public interface IDomainEventHandler<in TEvent> where TEvent : IDomainEvent
{
    Task HandleAsync(TEvent domainEvent, CancellationToken ct);
}
```

### 2) Dispatcherï¼šè¦³æ¸¬ã®ä¸­å¿ƒï¼ˆã“ã“ã§ãƒ­ã‚°ã‚’æƒãˆã‚‹ï¼‰ğŸ”­âœ¨

* ã“ã“ã§ **event_name / aggregate_id / correlation_id** ã‚’ã‚¹ã‚³ãƒ¼ãƒ—ã§ä»˜ã‘ã‚‹ğŸ§µğŸ§¾
* å„ãƒãƒ³ãƒ‰ãƒ©ã”ã¨ã« **é–‹å§‹ãƒ»çµ‚äº†ãƒ»æ™‚é–“ãƒ»å¤±æ•—ç†ç”±** ã‚’æ®‹ã™â±ï¸ğŸ§¯

```csharp
using System.Diagnostics;
using Microsoft.Extensions.Logging;

public sealed class DomainEventDispatcher
{
    private readonly ILogger<DomainEventDispatcher> _logger;
    private readonly IServiceProvider _serviceProvider;

    public DomainEventDispatcher(
        ILogger<DomainEventDispatcher> logger,
        IServiceProvider serviceProvider)
    {
        _logger = logger;
        _serviceProvider = serviceProvider;
    }

    public async Task DispatchAsync(
        string aggregateType,
        string aggregateId,
        IReadOnlyList<IDomainEvent> events,
        string correlationId,
        CancellationToken ct)
    {
        foreach (var ev in events)
        {
            var eventName = ev.GetType().Name;

            using var scope = _logger.BeginScope(new Dictionary<string, object>
            {
                ["aggregate_type"] = aggregateType,
                ["aggregate_id"] = aggregateId,
                ["event_name"] = eventName,
                ["correlation_id"] = correlationId,
                // Activity ãŒã‚ã‚Œã° TraceId/SpanId ã‚‚ä»˜ã‘ã‚‹ï¼ˆãƒ­ã‚°â‡„ãƒˆãƒ¬ãƒ¼ã‚¹ç›¸é–¢ç”¨ï¼‰
                ["trace_id"] = Activity.Current?.TraceId.ToString() ?? "",
                ["span_id"]  = Activity.Current?.SpanId.ToString()  ?? "",
            });

            _logger.LogInformation("Domain event dispatch started.");

            // ãƒãƒ³ãƒ‰ãƒ©ã‚’åˆ—æŒ™ï¼ˆDIã‹ã‚‰å–å¾—ï¼‰
            var handlerType = typeof(IEnumerable<>).MakeGenericType(
                typeof(IDomainEventHandler<>).MakeGenericType(ev.GetType()));

            var handlersObj = _serviceProvider.GetService(handlerType);
            if (handlersObj is not System.Collections.IEnumerable handlers)
            {
                _logger.LogWarning("No handlers found for domain event.");
                continue;
            }

            foreach (var handler in handlers)
            {
                var handlerName = handler.GetType().Name;
                var sw = Stopwatch.StartNew();

                try
                {
                    _logger.LogInformation("Handler started. {handler}", handlerName);

                    // å‹•çš„å‘¼ã³å‡ºã—ï¼ˆå­¦ç¿’ç”¨ã®ç°¡ç•¥ï¼‰
                    var method = handler.GetType().GetMethod("HandleAsync");
                    var task = (Task)method!.Invoke(handler, new object[] { ev, ct })!;
                    await task.ConfigureAwait(false);

                    sw.Stop();
                    _logger.LogInformation(
                        "Handler finished. {handler} {result} {duration_ms}",
                        handlerName, "success", sw.ElapsedMilliseconds);
                }
                catch (Exception ex)
                {
                    sw.Stop();
                    _logger.LogError(
                        ex,
                        "Handler failed. {handler} {result} {duration_ms}",
                        handlerName, "fail", sw.ElapsedMilliseconds);

                    // ã“ã“ã§ã€Œä¸»å‡¦ç†ã‚’å¤±æ•—æ‰±ã„ã«ã™ã‚‹ã‹ã€ã¯ç¬¬24ç« ã®æ–¹é‡ã«å¾“ã†ğŸ™‚
                    // å­¦ç¿’ç”¨ã¨ã—ã¦ã¯ã€ã¾ãšä¾‹å¤–ã‚’æŠ•ã’ç›´ã•ãšãƒ­ã‚°ã ã‘æ®‹ã™æ¡ˆã‚‚ã‚¢ãƒªã€‚
                }
            }

            _logger.LogInformation("Domain event dispatch finished.");
        }
    }
}
```

---

## ç›¸é–¢IDã‚’ä½œã‚‹å ´æ‰€ï¼ˆãŠã™ã™ã‚ï¼‰ğŸ§µâœ¨

ç›¸é–¢IDã¯ã€Œ1ã¤ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼ˆã‚³ãƒãƒ³ãƒ‰å‡¦ç†ï¼‰ã€ã®å…¥å£ã§ä½œã‚‹ã®ãŒåˆ†ã‹ã‚Šã‚„ã™ã„ã§ã™ğŸ™‚
ãã—ã¦å¯èƒ½ãªã‚‰ `Activity` ã‚‚é–‹å§‹ã™ã‚‹ã¨ã€TraceId/SpanId ãŒè‡ªç„¶ã«ä¹—ã‚Šã¾ã™ğŸ§µâœ¨
ï¼ˆTraceId/SpanId ã®è€ƒãˆæ–¹ã¯ .NET ã®åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚¹æ¦‚å¿µã¨ã—ã¦æ•´ç†ã•ã‚Œã¦ã„ã¾ã™ï¼‰([Microsoft Learn][2])

```csharp
using System.Diagnostics;

public static class Correlation
{
    private static readonly ActivitySource ActivitySource = new("MiniEC");

    public static IDisposable Start(string operationName, out string correlationId)
    {
        // correlation_id ã¯ã¾ãšã¯GUIDã§OKğŸ™‚
        correlationId = Guid.NewGuid().ToString("N");

        // Traceï¼ˆãƒˆãƒ¬ãƒ¼ã‚¹ï¼‰ã‚‚é–‹å§‹ã—ã¦ãŠãã¨ã€TraceId/SpanId ãŒä½¿ãˆã‚‹ğŸ§µ
        var activity = ActivitySource.StartActivity(operationName, ActivityKind.Internal);

        // è¿”ã™ IDisposable ã¯ activityï¼ˆnullãªã‚‰ç©ºï¼‰
        return activity ?? new NoopDisposable();
    }

    private sealed class NoopDisposable : IDisposable { public void Dispose() { } }
}
```

ä½¿ã†å´ã¯ã“ã‚“ãªæ„Ÿã˜ğŸ‘‡ğŸ› ï¸âœ¨

```csharp
public async Task MarkOrderAsPaidAsync(string orderId, CancellationToken ct)
{
    using var _ = Correlation.Start("MarkOrderAsPaid", out var correlationId);

    // ã“ã“ã§ Order.MarkAsPaid() â†’ DomainEvents ã‚’æºœã‚ã‚‹ â†’ DispatchAsync(...) ã®æµã‚Œ
}
```

---

## ãƒ­ã‚°ä¾‹ï¼ˆã“ã‚“ãªå½¢ã«ãªã£ã¦ã‚Œã°OKï¼‰ğŸ§¾âœ¨

æ§‹é€ åŒ–ãƒ­ã‚°ã®è‰¯ã•ã¯ã€Œå¾Œã‹ã‚‰æ¤œç´¢ã—ã‚„ã™ã„ã€ã“ã¨ğŸ™‚ğŸ”
ãŸã¨ãˆã°ã‚¤ãƒ¡ãƒ¼ã‚¸ğŸ‘‡ï¼ˆå®Ÿéš›ã®å‡ºåŠ›å½¢å¼ã¯ãƒ—ãƒ­ãƒã‚¤ãƒ€æ¬¡ç¬¬ï¼‰

```json
{
  "level": "Information",
  "message": "Handler finished.",
  "event_name": "OrderPaid",
  "aggregate_type": "Order",
  "aggregate_id": "order-123",
  "handler": "GrantPointHandler",
  "result": "success",
  "duration_ms": 42,
  "correlation_id": "b8c1...",
  "trace_id": "4bf92f3577b34da6a3ce929d0e0e4736",
  "span_id": "00f067aa0ba902b7"
}
```

---

## ãƒ¡ãƒˆãƒªã‚¯ã‚¹æœ€å°ã‚»ãƒƒãƒˆğŸ“ˆâœ¨ï¼ˆ2ã¤ã ã‘ã§ã„ã„ï¼‰

ãƒ­ã‚°ã¯â€œäº‹ä»¶ç°¿â€ğŸ§¾ã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯â€œä½“æ¸©è¨ˆâ€ğŸŒ¡ï¸ã§ã™ğŸ™‚
.NET ã¯ `System.Diagnostics.Metrics` ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨ˆè£…ã§ãã¾ã™ğŸ“ˆ([Microsoft Learn][5])

æœ€ä½é™ãŠã™ã™ã‚ã¯ã“ã®2ã¤ğŸ‘‡âœ¨

1. **ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡å¤±æ•—å›æ•°**ï¼ˆCounterï¼‰âŒğŸ”¢
2. **ãƒãƒ³ãƒ‰ãƒ©å‡¦ç†æ™‚é–“**ï¼ˆHistogramï¼‰â±ï¸ğŸ“Š

```csharp
using System.Diagnostics.Metrics;

public static class ObservabilityMetrics
{
    private static readonly Meter Meter = new("MiniEC.DomainEvents");

    public static readonly Counter<long> DispatchFailures =
        Meter.CreateCounter<long>("domain_event_dispatch_failures");

    public static readonly Histogram<double> HandlerDurationMs =
        Meter.CreateHistogram<double>("domain_event_handler_duration_ms");
}
```

Dispatcherã®ä¸­ã§ã“ã†ä½¿ã„ã¾ã™ğŸ‘‡

```csharp
// æˆåŠŸ/å¤±æ•—ã§è¨˜éŒ²
ObservabilityMetrics.HandlerDurationMs.Record(sw.Elapsed.TotalMilliseconds,
    KeyValuePair.Create<string, object?>("event_name", eventName),
    KeyValuePair.Create<string, object?>("handler", handlerName));

if (failed)
{
    ObservabilityMetrics.DispatchFailures.Add(1,
        KeyValuePair.Create<string, object?>("event_name", eventName),
        KeyValuePair.Create<string, object?>("handler", handlerName));
}
```

> ğŸ€è£œè¶³ï¼š`System.Diagnostics.Metrics` ã¯ OpenTelemetry ã®ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã¨ã‚‚çµ±åˆã—ã‚„ã™ã„è¨­è¨ˆã§ã™ğŸ“ˆğŸ”—([Microsoft Learn][6])

---

## ãƒ­ã‚°â‡„ãƒˆãƒ¬ãƒ¼ã‚¹â‡„ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¤–ã«å‡ºã™ï¼ˆOpenTelemetryæœ€å°ï¼‰ğŸššâœ¨

ã€Œé›†ã‚ã¦è¦‹ãˆã‚‹åŒ–ã—ãŸã„ã€ã«ãªã£ãŸã‚‰ OpenTelemetry ãŒä¾¿åˆ©ã§ã™ğŸ§°âœ¨
ç‰¹ã« production ã§ã¯ **OpenTelemetry Collector** çµŒç”±ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã®ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ğŸššğŸ“¦([OpenTelemetry][7])
ï¼ˆãƒ­ã‚°ã‚‚ `ILogger` ã‹ã‚‰å–ã‚Šè¾¼ã‚ã¾ã™ï¼‰([OpenTelemetry][8])

æœ€å°ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆæ¦‚å¿µã‚³ãƒ¼ãƒ‰ï¼‰ğŸ‘‡

```csharp
// builder.Services.AddOpenTelemetry()
//   .WithTracing(tracing =>
//   {
//       tracing.AddSource("MiniEC");
//       tracing.AddAspNetCoreInstrumentation();
//       tracing.AddHttpClientInstrumentation();
//       tracing.AddOtlpExporter(); // OTLP ã§ Collector ã¸
//   })
//   .WithMetrics(metrics =>
//   {
//       metrics.AddMeter("MiniEC.DomainEvents");
//       metrics.AddAspNetCoreInstrumentation();
//       metrics.AddOtlpExporter();
//   });
```

ãã—ã¦ã€ãƒ­ã‚°ã¨ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ç›¸é–¢ã—ãŸã„ãªã‚‰ **TraceId/SpanId ã‚’ãƒ­ã‚°ã«å…¥ã‚Œã‚‹**ã®ãŒåŸºæœ¬ã§ã™ğŸ§¾ğŸ”—ğŸ§µ([OpenTelemetry][3])

---

## â€œè¦‹ãˆã‚‹åŒ–â€ã®ãŸã‚ã®å°ã•ãªãƒ«ãƒ¼ãƒ«âœ…âœ¨

### ãƒ¬ãƒ™ãƒ«è¨­è¨ˆï¼ˆæœ€ä½é™ï¼‰ğŸ§¾

* `Information`ï¼šé–‹å§‹/çµ‚äº†/æˆåŠŸâœ…ï¼ˆæ—¥å¸¸ã®è¿½è·¡ï¼‰
* `Warning`ï¼šãŠã‹ã—ã„å…†å€™âš ï¸ï¼ˆãƒªãƒˆãƒ©ã‚¤äºˆå®šã€ãƒãƒ³ãƒ‰ãƒ©æœªç™»éŒ²ãªã©ï¼‰
* `Error`ï¼šå¤±æ•—âŒï¼ˆä¾‹å¤–ä»˜ãï¼‰

### ãƒ­ã‚°ã«å…¥ã‚Œãªã„ã‚‚ã®ğŸ™…â€â™€ï¸ğŸ§¯

* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ»ã‚«ãƒ¼ãƒ‰æƒ…å ±ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³ãƒ»å€‹äººæƒ…å ±ï¼ˆãã®ã¾ã¾ï¼‰ğŸ§¨
* å·¨å¤§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸¸ã”ã¨ï¼ˆãƒ­ã‚°è‚¥å¤§ï¼‰ğŸ˜ğŸ’¦

### ä¾‹å¤–ãƒ­ã‚°ã®ã‚³ãƒ„ğŸ§¯âœ¨

* `ex` ã‚’æ¸¡ã—ã¦ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚‚æ®‹ã™ï¼ˆåŸå› ã®å…¥å£ï¼‰ğŸ“Œ
* `error_type`ï¼ˆTransient/Permanentï¼‰ã‚‚ä¸€ç·’ã«æ®‹ã™ã¨é‹ç”¨ãŒæ¥½ğŸ”ğŸ§±

---

## ã‚„ã£ã¦ã¿ã‚ˆã†ğŸ› ï¸ğŸ€ï¼ˆæ¼”ç¿’ï¼‰

### æ¼”ç¿’1ï¼šãƒ­ã‚°é …ç›®ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’ä½œã‚‹ğŸ“‹âœ¨

ã€Œç¬¬26ç« ã®è¡¨ã€ã‚’ãã®ã¾ã¾ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ã«ã—ã¦ã€
`event_name / aggregate_id / handler / result / duration_ms / correlation_id` ã¯å¿…é ˆã«ã™ã‚‹âœ…ğŸ§¾

### æ¼”ç¿’2ï¼šBeginScopeã§æ³¨æ–‡IDã‚’å…¨ãƒ­ã‚°ã«ä»˜ã‘ã‚‹ğŸ§µ

* `DispatchAsync()` ã®æœ€åˆã§ `BeginScope`
* ã©ã®ãƒ­ã‚°ã«ã‚‚ `aggregate_id` ãŒä»˜ã„ã¦ã‚‹ã“ã¨ã‚’ç¢ºèªğŸ”âœ¨

### æ¼”ç¿’3ï¼šå‡¦ç†æ™‚é–“ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å…¥ã‚Œã‚‹â±ï¸ğŸ“ˆ

* `Histogram` ã« `handler` ã¨ `event_name` ã‚¿ã‚°ã‚’ä»˜ã‘ã‚‹
* ã€Œé…ã„ãƒãƒ³ãƒ‰ãƒ©ã€ãŒè¦‹ã¤ã‘ã‚‰ã‚Œã‚‹çŠ¶æ…‹ã«ã™ã‚‹ğŸ¢ğŸ”

---

## ãƒã‚§ãƒƒã‚¯âœ…ï¼ˆç†è§£åº¦ãƒŸãƒ‹ãƒ†ã‚¹ãƒˆï¼‰

1. ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡ã§ã€ŒæˆåŠŸãƒ­ã‚°ã€ã‚‚å¿…è¦ãªã®ã¯ãªãœï¼ŸğŸ™‚
2. `correlation_id` ã¨ `TraceId` ã¯ã©ã†é•ã†ï¼ŸğŸ§µ
3. `BeginScope` ã‚’ä½¿ã†ã¨ä½•ãŒå¬‰ã—ã„ï¼ŸğŸ§¾âœ¨
4. æœ€å°ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹2ã¤ï¼ˆCounter / Histogramï¼‰ã§ä½•ã‚’æ¸¬ã‚‹ï¼ŸğŸ“ˆâ±ï¸

---

## ãŠã¾ã‘ï¼šAIæ‹¡å¼µã«é ¼ã‚€ã¨ãã®â€œè‰¯ã„èãæ–¹â€ğŸ¤–ğŸ’¡

* ã€Œã“ã®ãƒ­ã‚°é …ç›®ï¼ˆè¡¨ï¼‰ã‚’æº€ãŸã™ `ILogger` å®Ÿè£…ã«ã—ã¦ã€BeginScopeã§å…±é€šé …ç›®ã‚’ä»˜ã‘ã¦ã€ğŸ§¾ğŸ§µ
* ã€Œä¾‹å¤–æ™‚ã« `error_type` ã‚’åˆ†é¡ã™ã‚‹æœ€å°ãƒ«ãƒ¼ãƒ«æ¡ˆã‚’å‡ºã—ã¦ã€ğŸ§¯ğŸ”
* ã€ŒHistogram/Counter ã®è¨ˆæ¸¬ãƒã‚¤ãƒ³ãƒˆã‚’ã€éä¸è¶³ãªããƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã€ğŸ“ˆğŸ”

ï¼ˆç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã¯ã€**â€œã“ã®ãƒ­ã‚°ã§ä½•ãŒè¿½ãˆã‚‹ï¼Ÿâ€**ã‚’è‡ªåˆ†ã®è¨€è‘‰ã§èª¬æ˜ã§ããŸã‚‰åˆæ ¼ğŸ“âœ¨ï¼‰

[1]: https://learn.microsoft.com/en-us/dotnet/core/extensions/logging?utm_source=chatgpt.com "Logging in C# - .NET"
[2]: https://learn.microsoft.com/ja-jp/dotnet/core/diagnostics/distributed-tracing-concepts?utm_source=chatgpt.com "åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚¹ã®æ¦‚å¿µ - .NET"
[3]: https://opentelemetry.io/docs/languages/dotnet/logs/correlation/?utm_source=chatgpt.com "Log correlation"
[4]: https://nblumhardt.com/2016/11/ilogger-beginscope/?utm_source=chatgpt.com "The semantics of ILogger.BeginScope()"
[5]: https://learn.microsoft.com/en-us/dotnet/core/diagnostics/metrics-instrumentation?utm_source=chatgpt.com "Creating Metrics - .NET"
[6]: https://learn.microsoft.com/ja-jp/dotnet/api/system.diagnostics.metrics?view=net-10.0&utm_source=chatgpt.com "System.Diagnostics.Metrics åå‰ç©ºé–“"
[7]: https://opentelemetry.io/docs/languages/dotnet/exporters/?utm_source=chatgpt.com "Exporters"
[8]: https://opentelemetry.io/ja/docs/languages/dotnet/logs/?utm_source=chatgpt.com "OpenTelemetry .NET logs"
