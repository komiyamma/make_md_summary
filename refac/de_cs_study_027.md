# ç¬¬27ç«  ãƒ†ã‚¹ãƒˆâ‘ ï¼šãƒ‰ãƒ¡ã‚¤ãƒ³ã®å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿã‚’ç¢ºèªï¼‰ğŸ§ªğŸ””

## ã“ã®ç« ã§ã‚„ã‚‹ã“ã¨ğŸ¯âœ¨

* **ãƒ‰ãƒ¡ã‚¤ãƒ³ã®çŠ¶æ…‹å¤‰æ›´**ï¼ˆä¾‹ï¼šæ”¯æ‰•ã„å®Œäº†ï¼‰ã‚’å‘¼ã¶
* ãã®çµæœã¨ã—ã¦

  * **çŠ¶æ…‹ãŒæ­£ã—ãå¤‰ã‚ã‚‹**âœ…
  * **ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãŒè¿½åŠ ã•ã‚Œã‚‹**âœ…
    ã‚’ **å˜ä½“ãƒ†ã‚¹ãƒˆã§ç¢ºèª**ã™ã‚‹ã‚ˆã€œï¼ğŸ§¡

---

## ã¾ãšå¤§äº‹ï¼šãƒ‰ãƒ¡ã‚¤ãƒ³å˜ä½“ãƒ†ã‚¹ãƒˆã¯ä½•ãŒã†ã‚Œã—ã„ï¼ŸğŸ¥°

ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½¿ã†ã¨ã€**ã€Œä½•ãŒèµ·ããŸã‹ã€**ãŒã‚³ãƒ¼ãƒ‰ã«æ®‹ã‚‹ã‚ˆã­ğŸ””
ãƒ†ã‚¹ãƒˆã§ã¯ãã‚Œã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§ã€

* ã€Œæ”¯æ‰•ã„å®Œäº†ã—ãŸã‚‰ã€OrderPaid ãŒå¿…ãšå‡ºã‚‹ã€ã¿ãŸã„ã«
  **ã‚¤ãƒ™ãƒ³ãƒˆãŒä»•æ§˜ï¼ˆãƒ«ãƒ¼ãƒ«ï¼‰ã«ãªã‚‹**ğŸ§©âœ¨
* DBã‚‚å¤–éƒ¨APIã‚‚ç„¡ã—ã§å›ã›ã‚‹ã‹ã‚‰
  **é€Ÿã„ãƒ»å®‰å®šãƒ»å£Šã‚Œã«ãã„**ğŸƒâ€â™€ï¸ğŸ’¨

---

## æœ€æ–°ã®ãƒ†ã‚¹ãƒˆç’°å¢ƒãƒ¡ãƒ¢ï¼ˆ2026å¹´1æœˆæ™‚ç‚¹ï¼‰ğŸ—“ï¸âœ¨

* .NET ã¯ **.NET 10 ç³»ãŒ LTS**ã¨ã—ã¦æä¾›ã•ã‚Œã¦ã„ã¦ã€æœˆæ¬¡ã§æ›´æ–°ã•ã‚Œã¦ã‚‹ã‚ˆã€œğŸªŸğŸ”§ ([Microsoft][1])
* xUnit ã¯ **v3 ç³»ï¼ˆä¾‹ï¼šxunit.v3 3.2.2ï¼‰**ãŒ NuGet ã§åˆ©ç”¨ã§ãã‚‹ã‚ˆğŸ§ª ([NuGet][2])
* Visual Studio ã®ãƒ†ã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼é€£æºã¯ **xunit.runner.visualstudio** ãŒæ‹…å½“ï¼ˆv3 ã‚‚å‹•ãï¼‰ğŸ§© ([NuGet][3])
* MSTest ã¯ **v4 ãŒ stable** ã¨ã—ã¦æ¡ˆå†…ã•ã‚Œã¦ã‚‹ã‚ˆï¼ˆç§»è¡Œã‚¬ã‚¤ãƒ‰ã‚ã‚Šï¼‰ğŸ§ª ([Microsoft Learn][4])

â€»ã“ã®ç« ã®ã‚µãƒ³ãƒ—ãƒ«ã¯ **xUnit** ã§æ›¸ãã­ï¼ˆèª­ã¿ã‚„ã™ãã¦å®šç•ªâœ¨ï¼‰

---

## è‰¯ã„ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³å˜ä½“ãƒ†ã‚¹ãƒˆã€3ã‹æ¡ğŸ“ŒğŸ§ 

1. **I/Oã—ãªã„**ï¼ˆDBãƒ»HTTPãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»æ™‚è¨ˆç›´èª­ã¿ã€ãœã‚“ã¶ç„¡ã—ï¼‰ğŸ™…â€â™€ï¸
2. **çŠ¶æ…‹**ã¨**ã‚¤ãƒ™ãƒ³ãƒˆ**ã ã‘è¦‹ã‚‹ï¼ˆå†…éƒ¨ã®å®Ÿè£…ã«ä¾å­˜ã—ãªã„ï¼‰ğŸ‘€âœ¨
3. **1ãƒ†ã‚¹ãƒˆï¼1ãƒ«ãƒ¼ãƒ«**ï¼ˆæ¬²å¼µã‚‰ãªã„ï¼‰ğŸ°

---

## ã‚µãƒ³ãƒ—ãƒ«ï¼šOrder ãŒ Paid ã«ãªã£ãŸã‚‰ OrderPaid ã‚’å‡ºã™ğŸ›’ğŸ’³ğŸ””

### â‘  ãƒ‰ãƒ¡ã‚¤ãƒ³å´ã®æœ€å°ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼‰ğŸ§©

ã€ŒçŠ¶æ…‹ãŒå¤‰ã‚ã£ãŸç¬é–“ã€ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’æºœã‚ã‚‹ã€è¶…ãƒ™ãƒ¼ã‚·ãƒƒã‚¯å‹ã ã‚ˆğŸ“®ğŸ§º

```csharp
// Domain/Events/IDomainEvent.cs
namespace MiniEC.Domain.Events;

public interface IDomainEvent
{
    DateTimeOffset OccurredAt { get; }
}
```

```csharp
// Domain/Orders/OrderStatus.cs
namespace MiniEC.Domain.Orders;

public enum OrderStatus
{
    Draft = 0,
    PendingPayment = 1,
    Paid = 2
}
```

```csharp
// Domain/Orders/OrderPaid.cs
using MiniEC.Domain.Events;

namespace MiniEC.Domain.Orders;

public sealed record OrderPaid(
    Guid OrderId,
    Guid PaymentId,
    DateTimeOffset OccurredAt
) : IDomainEvent;
```

```csharp
// Domain/Orders/Order.cs
using MiniEC.Domain.Events;

namespace MiniEC.Domain.Orders;

public sealed class Order
{
    private readonly List<IDomainEvent> _domainEvents = new();

    public Guid Id { get; }
    public OrderStatus Status { get; private set; } = OrderStatus.PendingPayment;

    // èª­ã¿å–ã‚Šå°‚ç”¨ã§å…¬é–‹ï¼ˆå¤–ã‹ã‚‰Addã•ã›ãªã„ï¼‰
    public IReadOnlyCollection<IDomainEvent> DomainEvents => _domainEvents.AsReadOnly();

    public Order(Guid id)
    {
        Id = id;
    }

    public void MarkAsPaid(Guid paymentId, DateTimeOffset occurredAt)
    {
        if (Status == OrderStatus.Paid)
            throw new InvalidOperationException("Order is already paid.");

        Status = OrderStatus.Paid;

        _domainEvents.Add(new OrderPaid(
            OrderId: Id,
            PaymentId: paymentId,
            OccurredAt: occurredAt
        ));
    }

    // ã€Œå›åã—ãŸã‚‰ç©ºã«ã™ã‚‹ã€æ´¾ãªã‚‰ã“ã‚Œï¼ˆã©ã£ã¡ã§ã‚‚OKâœ¨ï¼‰
    public IReadOnlyList<IDomainEvent> PullDomainEvents()
    {
        var events = _domainEvents.ToList();
        _domainEvents.Clear();
        return events;
    }
}
```

ãƒã‚¤ãƒ³ãƒˆã¯ã“ã“ğŸ‘‡ğŸ’¡

* `DateTimeOffset.UtcNow` ã‚’**ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ç›´æ¥å‘¼ã°ãš**ã€`occurredAt` ã‚’å¼•æ•°ã§å—ã‘å–ã‚‹
  â†’ ãƒ†ã‚¹ãƒˆãŒãƒ–ãƒ¬ãªã„ã‚ˆã€œğŸ§Šâœ¨

---

### â‘¡ ãƒ†ã‚¹ãƒˆå´ï¼šMarkAsPaid ã—ãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆãŒå…¥ã‚‹ã‹ç¢ºèªğŸ§ªğŸ””

#### xUnitï¼ˆæ¨™æº–Assertç‰ˆï¼‰âœï¸

```csharp
using MiniEC.Domain.Orders;
using Xunit;

public sealed class OrderDomainTests
{
    [Fact]
    public void MarkAsPaid_should_change_status_and_add_OrderPaid_event()
    {
        // Arrange ğŸ§¸
        var orderId = Guid.NewGuid();
        var paymentId = Guid.NewGuid();
        var occurredAt = new DateTimeOffset(2026, 1, 27, 0, 0, 0, TimeSpan.Zero);

        var order = new Order(orderId);

        // Act ğŸƒâ€â™€ï¸
        order.MarkAsPaid(paymentId, occurredAt);

        // Assert âœ…ï¼ˆçŠ¶æ…‹ï¼‰
        Assert.Equal(OrderStatus.Paid, order.Status);

        // Assert âœ…ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼‰
        var ev = Assert.Single(order.DomainEvents);
        var paid = Assert.IsType<OrderPaid>(ev);

        Assert.Equal(orderId, paid.OrderId);
        Assert.Equal(paymentId, paid.PaymentId);
        Assert.Equal(occurredAt, paid.OccurredAt);
    }
}
```

#### ã‚‚ã£ã¨èª­ã¿ã‚„ã™ãã—ãŸã„äººå‘ã‘ï¼ˆFluentAssertionsç‰ˆï¼‰ğŸŒ¸

FluentAssertions ã¯èª­ã¿ã‚„ã™ã„ã‘ã©ã€**v8 ä»¥é™ã¯ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ–¹é‡ãŒå¤‰ã‚ã£ãŸæ¡ˆå†…**ãŒã‚ã‚‹ã‹ã‚‰ã€ãƒãƒ¼ãƒ ã®ãƒ«ãƒ¼ãƒ«ã«åˆã‚ã›ã¦ã­ğŸ“œâœ¨ ([Fluent Assertions][5])

```csharp
using FluentAssertions;
using MiniEC.Domain.Orders;
using Xunit;

public sealed class OrderDomainTests_Fluent
{
    [Fact]
    public void MarkAsPaid_should_emit_OrderPaid()
    {
        var orderId = Guid.NewGuid();
        var paymentId = Guid.NewGuid();
        var occurredAt = new DateTimeOffset(2026, 1, 27, 0, 0, 0, TimeSpan.Zero);

        var order = new Order(orderId);

        order.MarkAsPaid(paymentId, occurredAt);

        order.Status.Should().Be(OrderStatus.Paid);

        order.DomainEvents.Should().ContainSingle()
            .Which.Should().BeOfType<OrderPaid>()
            .Subject.Should().BeEquivalentTo(new OrderPaid(orderId, paymentId, occurredAt));
    }
}
```

---

## è¿½åŠ ã§ã€Œä»•æ§˜ã£ã½ã„ãƒ†ã‚¹ãƒˆã€ã‚’ã‚‚ã†1ã¤ğŸ§ªğŸ§¡

ã€ŒäºŒé‡æ”¯æ‰•ã„ã¯ç¦æ­¢ï¼ã€ã¿ãŸã„ãªä¸å¤‰æ¡ä»¶ã‚’ãƒ†ã‚¹ãƒˆã§å›ºã‚ã‚‹ã¨ã€å®‰å¿ƒæ„ŸãŒä¸€æ°—ã«ä¸ŠãŒã‚‹ã‚ˆğŸ”’âœ¨

```csharp
using MiniEC.Domain.Orders;
using Xunit;

public sealed class OrderDomainInvariantTests
{
    [Fact]
    public void MarkAsPaid_twice_should_throw_and_not_add_second_event()
    {
        var order = new Order(Guid.NewGuid());
        var t = new DateTimeOffset(2026, 1, 27, 0, 0, 0, TimeSpan.Zero);

        order.MarkAsPaid(Guid.NewGuid(), t);

        var beforeCount = order.DomainEvents.Count;

        Assert.Throws<InvalidOperationException>(() =>
            order.MarkAsPaid(Guid.NewGuid(), t.AddMinutes(1)));

        Assert.Equal(beforeCount, order.DomainEvents.Count);
    }
}
```

ã“ã“ã§ã®æ°—æŒã¡ã„ã„ãƒã‚¤ãƒ³ãƒˆğŸ‘‡ğŸ˜

* ä¾‹å¤–ãŒå‡ºã‚‹ã®ã‚‚ **ä»•æ§˜**
* ã€Œã‚¤ãƒ™ãƒ³ãƒˆãŒå¢—ãˆãªã„ã€ã‚‚ **ä»•æ§˜**
  ã“ã®2ã¤ãŒãƒ†ã‚¹ãƒˆã§å›ºå®šã•ã‚Œã‚‹âœ¨

---

## ã‚ã‚ŠãŒã¡è½ã¨ã—ç©´ã‚ã‚‹ã‚ã‚‹âš ï¸ğŸ˜µâ€ğŸ’«

* **ã‚¤ãƒ™ãƒ³ãƒˆã®ä¸­ã« â€œã§ã£ã‹ã„æ³¨æ–‡ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸¸ã”ã¨â€ ã‚’å…¥ã‚Œã‚‹**
  â†’ ãƒ†ã‚¹ãƒˆãŒé‡ã„ï¼†ä¾å­˜ãŒå¢—ãˆã‚‹ğŸ˜ğŸ’¦
* **DateTime.Now / UtcNow ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒç›´æ¥ä½¿ã†**
  â†’ ãƒ†ã‚¹ãƒˆãŒä¸å®‰å®šã«ãªã‚‹ï¼ˆç‰¹ã«ä¸¦åˆ—ã‚„å¢ƒç•Œï¼‰â±ï¸ğŸ’¥
* **ã‚¤ãƒ™ãƒ³ãƒˆã®æ•°ã‚„å‹ã ã‘è¦‹ã¦ã€å†…å®¹ï¼ˆOrderIdãªã©ï¼‰ã‚’è¦‹ãªã„**
  â†’ ã†ã£ã‹ã‚Šãƒã‚°ãŒã™ã‚ŠæŠœã‘ã‚‹ğŸ•³ï¸

---

## Copilot / Codex ã«é ¼ã‚€ã¨ãã®ã‚³ãƒ„ğŸ¤–âœ¨

ã€Œãƒ†ã‚¹ãƒˆã®é››å½¢ã‚’ä½œã‚‰ã›ã‚‹ã€ã®ã¯è¶…ã‚¢ãƒªï¼ğŸ§
ãŸã ã—ã€**ä»•æ§˜ã®åˆ¤æ–­ï¼ˆä½•ã‚’ä¿è¨¼ã—ãŸã„ã‹ï¼‰**ã¯äººé–“ãŒæ±ºã‚ã‚‹ã®ãŒæœ€å¼·ã ã‚ˆğŸ’ªğŸ™‚

ä½¿ã„ã‚„ã™ã„ãŠé¡˜ã„ä¾‹ğŸ‘‡

* ã€Œ`Order.MarkAsPaid` ã® **å˜ä½“ãƒ†ã‚¹ãƒˆ**ã‚’ xUnit ã§ä½œã£ã¦ã€‚
  **çŠ¶æ…‹**ã¨ **OrderPaid ã‚¤ãƒ™ãƒ³ãƒˆ**ã®ä¸¡æ–¹ã‚’æ¤œè¨¼ã—ã¦ã€
* ã€ŒäºŒé‡æ”¯æ‰•ã„ã®ã‚±ãƒ¼ã‚¹ã‚‚è¿½åŠ ã—ã¦ã€‚ä¾‹å¤–ã¨ã‚¤ãƒ™ãƒ³ãƒˆæ•°ã‚’ç¢ºèªã—ã¦ã€

---

## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆâœ…ğŸ“‹

* [ ] ãƒ†ã‚¹ãƒˆãŒ **I/Oç„¡ã—**ã§å‹•ã„ã¦ã‚‹
* [ ] **çŠ¶æ…‹**ï¼ˆPaidã«ãªã£ãŸï¼‰ã‚’ç¢ºèªã—ã¦ã‚‹
* [ ] **ã‚¤ãƒ™ãƒ³ãƒˆ**ï¼ˆOrderPaidãŒå‡ºãŸï¼‰ã‚’ç¢ºèªã—ã¦ã‚‹
* [ ] ã‚¤ãƒ™ãƒ³ãƒˆã®ä¸­èº«ï¼ˆOrderId / occurredAt ãªã©ï¼‰ã‚‚è¦‹ã¦ã‚‹
* [ ] ä¸å¤‰æ¡ä»¶ï¼ˆä¾‹ï¼šäºŒé‡æ”¯æ‰•ã„ç¦æ­¢ï¼‰ã‚‚1ã¤ãƒ†ã‚¹ãƒˆã«ã§ããŸ ğŸ”’âœ¨

[1]: https://dotnet.microsoft.com/ja-jp/download/dotnet?utm_source=chatgpt.com "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã™ã¹ã¦ã® .NET ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å‚ç…§ã™ã‚‹"
[2]: https://www.nuget.org/packages/xunit.v3?utm_source=chatgpt.com "xunit.v3 3.2.2"
[3]: https://www.nuget.org/packages/xunit.runner.visualstudio?utm_source=chatgpt.com "xunit.runner.visualstudio 3.1.5"
[4]: https://learn.microsoft.com/en-us/dotnet/core/testing/unit-testing-mstest-migration-v3-v4?utm_source=chatgpt.com "MSTest migration from v3 to v4 - .NET"
[5]: https://www.fluentassertions.com/releases/?utm_source=chatgpt.com "Releases"
