# ç¬¬32ç«  å¤–éƒ¨å…¬é–‹ã¨æ¬¡ã®ä¸€æ­©ï¼šçµ±åˆã‚¤ãƒ™ãƒ³ãƒˆãƒ»ACLãƒ»å¥‘ç´„ãƒ»Sagaã®å…¥å£ğŸŒğŸ“œğŸ”—

## 0. ã“ã®ç« ã§ã‚ã‹ã‚‹ã“ã¨ğŸ“âœ¨

* **ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå†…éƒ¨ï¼‰** ã¨ **çµ±åˆã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå¤–éƒ¨ï¼‰** ã‚’ã€ã¡ã‚ƒã‚“ã¨åˆ¥ç‰©ã¨ã—ã¦æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ””ğŸ“¨
* å¤–éƒ¨ã«å‡ºã™ã¨ãã«å¿…è¦ãª **ã€Œå¥‘ç´„ã€**ï¼ˆå£Šã•ãšé€²åŒ–ã•ã›ã‚‹ãƒ«ãƒ¼ãƒ«ï¼‰ã‚’æŒã¦ã‚‹ğŸ“œâœ…
* å¤–éƒ¨ã®â€œã‚¯ã‚»â€ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³ã«æŒã¡è¾¼ã¾ãªã„ **ACLï¼ˆç¿»è¨³å±¤ï¼‰** ãŒä½œã‚Œã‚‹ğŸ§¼ğŸ›¡ï¸
* åˆ†æ•£ã—ãŸè¤‡æ•°ã‚¹ãƒ†ãƒƒãƒ—ã®æ•´åˆæ€§ã‚’æ‰±ã† **Sagaï¼ˆè£œå„Ÿä»˜ãã®æµã‚Œï¼‰** ã®å…¥å£ãŒã¤ã‹ã‚ã‚‹â™»ï¸ğŸ§©

---

## 1. ã¾ãšçµè«–ï¼šå¤–ã«å‡ºã™ãªã‚‰ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãã®ã¾ã¾å‡ºã•ãªã„ã€ğŸ™…â€â™€ï¸ğŸ“¤

### ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆDomain Eventï¼‰â¤ï¸ğŸ””

* **è‡ªåˆ†ã®å¢ƒç•Œï¼ˆBounded Contextï¼‰ã®ä¸­ã ã‘** ã§é€šã˜ã‚‹ã€Œèµ·ããŸäº‹å®Ÿã€
* ç›®çš„ï¼š**ãƒ¢ãƒ‡ãƒ«ã®ä¸­ã®å¤‰åŒ–**ã‚’è¡¨ã™ï¼ˆï¼è¨­è¨ˆã®ä¸­å¿ƒï¼‰
* å®Ÿè£…ï¼šåŒä¸€ãƒ—ãƒ­ã‚»ã‚¹å†…ã®ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒï¼ˆin-memoryï¼‰ã«ãªã‚ŠãŒã¡ ([Microsoft Learn][1])

### çµ±åˆã‚¤ãƒ™ãƒ³ãƒˆï¼ˆIntegration Eventï¼‰ğŸŒğŸ“¨

* **å¢ƒç•Œã®å¤–**ï¼ˆåˆ¥ã‚µãƒ¼ãƒ“ã‚¹ãƒ»åˆ¥ã‚·ã‚¹ãƒ†ãƒ ãƒ»åˆ†æåŸºç›¤ãƒ»ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ï¼‰ã¸ã€ŒçŸ¥ã‚‰ã›ã‚‹ã€ãŸã‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
* ç›®çš„ï¼š**å¤–éƒ¨ã¨ç–çµåˆã§ã¤ãªãŒã‚‹**
* å®Ÿè£…ï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ï¼ˆQueue/Topic/EventBusï¼‰ã§éåŒæœŸã«ãªã‚ŠãŒã¡ ([Microsoft Learn][2])

âœ… ã“ã“ãŒè¶…å¤§äº‹ï¼š
**ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã¯â€œè‡ªåˆ†ç”¨ã®è¨€è‘‰â€**ã€**çµ±åˆã‚¤ãƒ™ãƒ³ãƒˆã¯â€œå¤–éƒ¨ã¨ç´„æŸã™ã‚‹è¨€è‘‰ï¼ˆå¥‘ç´„ï¼‰â€** ğŸ“œâœ¨
ï¼ˆåŒã˜ã€Œã‚¤ãƒ™ãƒ³ãƒˆã€ã§ã‚‚ã€è²¬ä»»ãŒé•ã†ã®ï¼ï¼‰

---

## 2. ã€Œå¥‘ç´„ã€ã£ã¦ãªã«ï¼ŸğŸ“œâœ¨ï¼ˆï¼å£Šã•ãšé€²åŒ–ã•ã›ã‚‹ãƒ«ãƒ¼ãƒ«ï¼‰

å¤–ã«å…¬é–‹ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€ã‚‚ã† **ã‚ãªãŸã®éƒ½åˆã§è‡ªç”±ã«å¤‰ãˆã‚‰ã‚Œãªã„** ğŸ˜­
ã ã‹ã‚‰ **å¥‘ç´„ï¼ˆContractï¼‰** ã‚’æ±ºã‚ã‚‹ã‚ˆï¼

### å¥‘ç´„ã«å«ã‚ãŸã„æœ€å°ã‚»ãƒƒãƒˆğŸ§¾

* **ã‚¤ãƒ™ãƒ³ãƒˆåï¼ˆTypeï¼‰**ï¼šä¾‹ `order.payment.completed`
* **ã‚¤ãƒ™ãƒ³ãƒˆID**ï¼šé‡è¤‡æ¤œçŸ¥ã«ä½¿ã†ï¼ˆå¾Œã§å¤§åŠ©ã‹ã‚Šï¼‰ğŸ†”
* **ç™ºç”Ÿæ™‚åˆ»**ï¼šãƒ­ã‚°ãƒ»è¿½è·¡ã«å¿…é ˆğŸ•’
* **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**ï¼šå°†æ¥ã®å¤‰æ›´ã«å‚™ãˆã‚‹ï¼ˆå¾Œè¿°ï¼‰ğŸ”
* **Payloadï¼ˆDataï¼‰**ï¼šå¿…è¦æœ€å°é™ã ã‘ğŸ“¦âœ‚ï¸

> ğŸ’¡ã€Œå¤–éƒ¨ãŒçŸ¥ã‚ŠãŸã„ã“ã¨ã€ã ã‘ã‚’è¼‰ã›ã‚‹ã€‚
> â€œå†…éƒ¨ã®éƒ½åˆâ€ã‚„â€œå·¨å¤§ãªãƒ¢ãƒ‡ãƒ«ä¸¸ã”ã¨â€ã¯è¼‰ã›ãªã„ğŸ™…â€â™€ï¸ğŸ˜

### CloudEvents ã£ã¦ï¼Ÿï¼ˆã‚¤ãƒ™ãƒ³ãƒˆã®å…±é€šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰â˜ï¸ğŸ“¦

ã‚¯ãƒ©ã‚¦ãƒ‰ã‚„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’ã¾ãŸã„ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ‰±ã„ã‚„ã™ãã™ã‚‹ãŸã‚ã®ä»•æ§˜ã ã‚ˆğŸ“âœ¨
ã€Œidã€ã€Œtypeã€ã€Œsourceã€ã€Œtimeã€ãªã©ã€å…±é€šã®â€œå°ç­’â€ã‚’å®šç¾©ã—ã¦ãã‚Œã‚‹æ„Ÿã˜ğŸ“©
([GitHub][3])

ï¼ˆå¿…é ˆã˜ã‚ƒãªã„ã‘ã©ã€çµ±åˆãŒå¢—ãˆã‚‹ã»ã©ä¾¿åˆ©ã«ãªã‚ŠãŒã¡ğŸ‘ï¼‰

---

## 3. ACLï¼ˆAnti-Corruption Layerï¼‰ï¼â€œç¿»è¨³ä¿‚â€ğŸ§¼ğŸ›¡ï¸

å¤–éƒ¨ã¨ã¤ãªãã¨ã€ã ã„ãŸã„ã“ã†ãªã‚‹ğŸ‘‡

* å¤–éƒ¨ã®ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒå¤‰ğŸ’¦ï¼ˆå‘½åã‚‚ç²’åº¦ã‚‚é•ã†ï¼‰
* å¤–éƒ¨ã®æ¦‚å¿µãŒãƒ‰ãƒ¡ã‚¤ãƒ³ã«æ··ã–ã‚‹ã¨ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒæ±šã‚Œã‚‹ğŸ˜µâ€ğŸ’«

ãã“ã§ **ACLï¼ˆç¿»è¨³å±¤ï¼‰** ã‚’ç½®ãï¼

### ACLã®å½¹å‰²ğŸ€

* **ãƒ‰ãƒ¡ã‚¤ãƒ³ã®è¨€è‘‰ â†” å¤–éƒ¨ã®è¨€è‘‰** ã‚’ç¿»è¨³ã™ã‚‹
* å¤–éƒ¨ã®å¤‰æ›´ãŒæ¥ã¦ã‚‚ã€**ãƒ‰ãƒ¡ã‚¤ãƒ³å…¨ä½“ã«æ³¢åŠã—ãªã„**
  ([Microsoft Learn][4])

---

## 4. Outboxï¼ˆå‰ç« ï¼‰ã¨ã‚»ãƒƒãƒˆã§è¦šãˆã‚‹ï¼šå¤–éƒ¨å…¬é–‹ã®å®šçŸ³ğŸ—ƒï¸ğŸšš

ã€ŒDBæ›´æ–°ã¯æˆåŠŸâœ…ã€ã§ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡ãŒå¤±æ•—âŒã€ã¿ãŸã„ãªã‚ºãƒ¬äº‹æ•…ã‚’æ¸›ã‚‰ã™å®šç•ªãŒ **Transactional Outbox** ã ã‚ˆğŸ“¦âœ¨
([Microsoft Learn][5])

ã–ã£ãã‚Šæµã‚Œã¯ã“ã†ğŸ‘‡

1. ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”ŸğŸ””
2. ã‚¢ãƒ—ãƒªå±¤ã§ **çµ±åˆã‚¤ãƒ™ãƒ³ãƒˆã«å¤‰æ›** ğŸ§¼ï¼ˆACL/Mapperï¼‰
3. DBãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ **Outboxã«ä¿å­˜** ğŸ—ƒï¸
4. åˆ¥ãƒ—ãƒ­ã‚»ã‚¹/HostedServiceãŒ **Outboxã‚’é€ä¿¡** ğŸššğŸ“¨
5. é€ä¿¡æ¸ˆã¿ã‚’ãƒãƒ¼ã‚¯âœ…

---

## 5. â€œå£Šã•ãšé€²åŒ–â€ã•ã›ã‚‹ï¼šãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã®è€ƒãˆæ–¹ğŸ”ğŸ“œ

### 5-1. ã‚ˆãã‚ã‚‹2ã¤ã®ä½œæˆ¦ğŸ®

**A) ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ™ãƒ³ãƒˆåã«å…¥ã‚Œã‚‹**

* `order.payment.completed.v1` â†’ `...v2`
* ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚„é‹ç”¨ã§ã‚ã‹ã‚Šã‚„ã™ã„ğŸ‘

**B) åŒã˜ã‚¤ãƒ™ãƒ³ãƒˆåã§ã€schemaVersionã‚’æŒã¤**

* `type = order.payment.completed`
* `schemaVersion = 1`ï¼ˆpayloadå†… or ãƒ˜ãƒƒãƒ€ï¼‰

ã©ã£ã¡ã§ã‚‚OKã€‚å¤§äº‹ãªã®ã¯ **â€œäº’æ›æ€§ãƒ«ãƒ¼ãƒ«â€** ã‚’æ±ºã‚ã‚‹ã“ã¨âœ¨

### 5-2. äº’æ›æ€§ã®è¶…ã–ã£ãã‚Šãƒ«ãƒ¼ãƒ«âœ…

* **è¿½åŠ ã¯ã—ã‚„ã™ã„**ï¼šæ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã€Œä»»æ„ã€ã§è¿½åŠ ğŸ§©
* **å‰Šé™¤ãƒ»æ„å‘³å¤‰æ›´ã¯å±é™º**ï¼šæ—¢å­˜ã®åˆ©ç”¨è€…ãŒå£Šã‚Œã‚‹ğŸ’¥
* **å‹å¤‰æ›´ã¯åŸå‰‡NG**ï¼š`int`â†’`string` ã¨ã‹åœ°ç„ğŸ‘¹

---

## 6. ç¾å®Ÿï¼šçµ±åˆã‚¤ãƒ™ãƒ³ãƒˆã¯ã€Œé‡è¤‡ã€ã—ã¦å±Šãå‰æğŸ“¨ğŸ“¨ğŸ“¨ï¼ˆã ã‹ã‚‰å†ªç­‰æ€§ï¼ï¼‰

å¤šãã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã¯ **at-least-onceï¼ˆæœ€ä½1å›ã€ãŸã¾ã«é‡è¤‡ï¼‰** ãŒç¾å®Ÿçš„ã€‚
ã ã‹ã‚‰å—ä¿¡å´ã¯ **å†ªç­‰ï¼ˆåŒã˜ã‚¤ãƒ™ãƒ³ãƒˆã‚’2å›å‡¦ç†ã—ã¦ã‚‚çµæœãŒåŒã˜ï¼‰** ã«ã™ã‚‹ã®ãŒé‰„æ¿âœ…

### æœ€å°ã®ã‚„ã‚Šæ–¹ï¼šInboxï¼ˆå‡¦ç†æ¸ˆã¿IDï¼‰ğŸ§¾ğŸ§¹

* `ProcessedMessageIds` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆor ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ã« **ã‚¤ãƒ™ãƒ³ãƒˆID** ã‚’ä¿å­˜
* ã™ã§ã«å‡¦ç†æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—ğŸ‘‹

---

## 7. Sagaï¼ˆã‚µã‚¬ï¼‰å…¥é–€ï¼šè¤‡æ•°ã‚µãƒ¼ãƒ“ã‚¹ã«ã¾ãŸãŒã‚‹â€œé•·ã„å‡¦ç†â€â™»ï¸ğŸ§©

### Sagaã£ã¦ãªã«ï¼ŸğŸ¤”

* ã€Œåˆ†æ•£ã—ãŸå–å¼•ï¼ˆä¾‹ï¼šæ³¨æ–‡â†’æ±ºæ¸ˆâ†’åœ¨åº«â†’é…é€ï¼‰ã€ã‚’
  **ã‚¤ãƒ™ãƒ³ãƒˆ/ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã¤ãªããªãŒã‚‰** é€²ã‚ã‚‹è€ƒãˆæ–¹
* é€”ä¸­ã§å¤±æ•—ã—ãŸã‚‰ã€**è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³**ã§æˆ»ã™ï¼ˆä¾‹ï¼šè¿”é‡‘ã€åœ¨åº«æˆ»ã—ï¼‰â™»ï¸
  ([Microsoft Learn][6])

### ãƒŸãƒ‹ECã§ä¾‹ãˆã‚‹ã¨ğŸ›’ğŸ“¦

1. æ³¨æ–‡ç¢ºå®šâœ…ï¼ˆOrderï¼‰
2. æ±ºæ¸ˆç¢ºä¿âœ…ï¼ˆPaymentï¼‰
3. åœ¨åº«å¼•å½“âœ…ï¼ˆInventoryï¼‰
4. é…é€æ‰‹é…âœ…ï¼ˆShippingï¼‰

ã‚‚ã— 3) åœ¨åº«å¼•å½“ãŒå¤±æ•—ã—ãŸã‚‰â€¦

* 2) ã‚’ **è¿”é‡‘ï¼ˆè£œå„Ÿï¼‰** ğŸ’¸
* 1. ã‚’ **ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆè£œå„Ÿï¼‰** ğŸ§¾

ã€Œå…¨éƒ¨ã‚’1å€‹ã®å·¨å¤§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«ã—ãªã„ã€ä»£ã‚ã‚Šã«ã€
**æˆ»ã™æ‰‹é †ï¼ˆè£œå„Ÿï¼‰ã‚‚è¨­è¨ˆã™ã‚‹**ã£ã¦æ„Ÿã˜ã ã‚ˆâœ¨ ([Microsoft Learn][6])

---

## 8. ã‚„ã£ã¦ã¿ã‚ˆã†ğŸ› ï¸ï¼šå†…éƒ¨ã‚¤ãƒ™ãƒ³ãƒˆ â†’ å¤–éƒ¨ã‚¤ãƒ™ãƒ³ãƒˆã¸å¤‰æ›ã—ã¦Outboxã¸ğŸ“®ğŸ§º

é¡Œæï¼š

* å†…éƒ¨ï¼š`OrderPaid`ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆï¼‰â¤ï¸ğŸ””
* å¤–éƒ¨ï¼š`OrderPaymentCompletedV1`ï¼ˆçµ±åˆã‚¤ãƒ™ãƒ³ãƒˆï¼‰ğŸŒğŸ“¨

### 8-1. ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå†…éƒ¨ï¼‰ğŸ””

```csharp
public interface IDomainEvent
{
    DateTimeOffset OccurredAt { get; }
}

public sealed record OrderPaid(
    Guid OrderId,
    decimal Amount,
    string Currency,
    DateTimeOffset OccurredAt
) : IDomainEvent;
```

âœ… å†…éƒ¨ã‚¤ãƒ™ãƒ³ãƒˆãªã®ã§ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒæ‰±ã„ã‚„ã™ã„å½¢ã§OKã€‚
ï¼ˆãŸã ã—å·¨å¤§åŒ–ã¯ã•ã›ãªã„ã®ãŒå‰ğŸ“¦âœ‚ï¸ï¼‰

### 8-2. çµ±åˆã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå¤–éƒ¨å¥‘ç´„ï¼‰ğŸ“œ

```csharp
public interface IIntegrationEvent
{
    Guid EventId { get; }
    string Type { get; }          // å¥‘ç´„ä¸Šã®åå‰
    int SchemaVersion { get; }    // ä¾‹: 1
    DateTimeOffset Time { get; }  // ç™ºç”Ÿæ™‚åˆ»
}

public sealed record OrderPaymentCompletedV1(
    Guid EventId,
    Guid OrderId,
    decimal PaidAmount,
    string Currency,
    DateTimeOffset Time,
    int SchemaVersion = 1
) : IIntegrationEvent
{
    public string Type => "order.payment.completed";
}
```

ãƒã‚¤ãƒ³ãƒˆğŸ’¡

* **EventId** ã‚’å¿…ãšæŒã¤ï¼ˆé‡è¤‡å¯¾ç­–ã®æ ¸ï¼‰ğŸ†”
* `Type` ã¯å¤–éƒ¨å¥‘ç´„ã€‚å†…éƒ¨ã®ã‚¯ãƒ©ã‚¹åã¨ä¸€è‡´ã—ãªãã¦OKğŸ™†â€â™€ï¸
* `SchemaVersion` ã¯â€œé€²åŒ–â€ã®ãŸã‚ã®ä¿é™ºğŸ”

### 8-3. ACL/Mapperï¼ˆç¿»è¨³ä¿‚ï¼‰ğŸ§¼

```csharp
public static class IntegrationEventMapper
{
    public static OrderPaymentCompletedV1 ToIntegrationEvent(OrderPaid domainEvent)
        => new(
            EventId: Guid.NewGuid(),
            OrderId: domainEvent.OrderId,
            PaidAmount: domainEvent.Amount,
            Currency: domainEvent.Currency,
            Time: domainEvent.OccurredAt
        );
}
```

âœ… ã“ã“ãŒACLã®â€œè¶…ãƒŸãƒ‹ç‰ˆâ€ã€‚
å¤–éƒ¨éƒ½åˆãŒå¢—ãˆãŸã‚‰ã€ã“ã®å±¤ãŒã©ã‚“ã©ã‚“ä¾¡å€¤ã‚’å‡ºã™ã‚ˆğŸ›¡ï¸âœ¨

### 8-4. Outboxã¸ä¿å­˜ï¼ˆé€ä¿¡ã¯å¾Œã§ï¼‰ğŸ—ƒï¸

```csharp
public sealed class OutboxMessage
{
    public Guid Id { get; init; }
    public string Type { get; init; } = "";
    public int SchemaVersion { get; init; }
    public string PayloadJson { get; init; } = "";
    public DateTimeOffset OccurredAt { get; init; }
}

public static class OutboxWriter
{
    public static OutboxMessage ToOutboxMessage(IIntegrationEvent ev)
        => new()
        {
            Id = ev.EventId,
            Type = ev.Type,
            SchemaVersion = ev.SchemaVersion,
            OccurredAt = ev.Time,
            PayloadJson = System.Text.Json.JsonSerializer.Serialize(ev)
        };
}
```

âœ… é€ä¿¡å‡¦ç†ï¼ˆService Bus / RabbitMQ / Kafka ãªã©ï¼‰ã¯ã€ã“ã®ç« ã§ã¯ **â€œå¤–å´ã®å®Ÿè£…â€**ã€‚
ã€ŒOutboxã«ç¢ºå®Ÿã«å…¥ã£ãŸã€ã“ã¨ãŒã€ã¾ãšå‹ã¡ğŸ

---

## 9. ã‚„ã£ã¦ã¿ã‚ˆã†ğŸ› ï¸ï¼šSagaã‚’â€œç´™ã«â€è¨­è¨ˆã—ã¦ã¿ã‚‹ğŸ“â™»ï¸

### 9-1. Sagaã®è¨­è¨ˆãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆè¶…å®Ÿç”¨ï¼‰ğŸ“‹âœ¨

* **ç›®çš„**ï¼šä½•ã‚’æœ€çµ‚çš„ã«é”æˆã—ãŸã„ï¼ŸğŸ¯
* **ã‚¹ãƒ†ãƒƒãƒ—**ï¼šã©ã®é †ç•ªã§ä½•ã‚’ã™ã‚‹ï¼ŸğŸ”
* **å„ã‚¹ãƒ†ãƒƒãƒ—ã®æˆåŠŸæ¡ä»¶**ï¼šä½•ãŒç¢ºèªã§ããŸã‚‰æˆåŠŸï¼Ÿâœ…
* **å¤±æ•—æ™‚ã®è£œå„Ÿ**ï¼šå¤±æ•—ã—ãŸã‚‰ä½•ã§æˆ»ã™ï¼Ÿâ™»ï¸
* **çŠ¶æ…‹**ï¼šä»Šã©ã“ã¾ã§é€²ã‚“ã ï¼Ÿï¼ˆçŠ¶æ…‹æ©Ÿæ¢°ã£ã½ãï¼‰ğŸš¦

ä¾‹ï¼ˆè¶…ã–ã£ãã‚Šï¼‰ğŸ›’

* Startï¼šOrderPlaced
* Step1ï¼šPaymentAuthorizedï¼ˆå¤±æ•—â†’OrderCanceledï¼‰
* Step2ï¼šInventoryReservedï¼ˆå¤±æ•—â†’PaymentRefunded â†’ OrderCanceledï¼‰
* Step3ï¼šShipmentCreatedï¼ˆå¤±æ•—â†’InventoryReleased â†’ PaymentRefunded â†’ OrderCanceledï¼‰

ã“ã®ã€Œè£œå„Ÿã®åˆ—ã€ã‚’æ›¸ã‘ã‚‹ã ã‘ã§ã€è¨­è¨ˆãƒ¬ãƒ™ãƒ«ãŒä¸€æ°—ã«ä¸ŠãŒã‚‹ã‚ˆğŸ“ˆâœ¨ ([Microsoft Learn][6])

---

## 10. AIæ´»ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ğŸ¤–ğŸ’¡ï¼ˆãã®ã¾ã¾ã‚³ãƒ”ãƒšOKï¼‰

* ã€Œ`order.payment.completed` ã®çµ±åˆã‚¤ãƒ™ãƒ³ãƒˆå¥‘ç´„ã‚’ã€å£Šã•ãšé€²åŒ–ã•ã›ã‚‹ãŸã‚ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æ–¹é‡ã‚’3æ¡ˆãã ã•ã„ã€‚äº’æ›æ€§ãƒ«ãƒ¼ãƒ«ã‚‚ã‚»ãƒƒãƒˆã§ã€
* ã€Œå¤–éƒ¨æ±ºæ¸ˆAPIã® `settled/paid/authorized` ã‚’ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã® `PaymentStatus` ã«ç¿»è¨³ã™ã‚‹ACLè¨­è¨ˆã‚’ææ¡ˆã—ã¦ã€‚å¤‰æ›ãƒ†ãƒ¼ãƒ–ãƒ«æ¡ˆã‚‚ã€
* ã€Œæ³¨æ–‡â†’æ±ºæ¸ˆâ†’åœ¨åº«â†’é…é€ã®Sagaã‚’ã€å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ã«è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä»˜ãã§è¡¨ã«ã—ã¦ã€

---

## 11. ãƒã‚§ãƒƒã‚¯âœ…ï¼ˆã“ã®ç« ã®ã‚´ãƒ¼ãƒ«åˆ¤å®šğŸ€ï¼‰

* [ ] å†…éƒ¨ã‚¤ãƒ™ãƒ³ãƒˆã¨å¤–éƒ¨ã‚¤ãƒ™ãƒ³ãƒˆã‚’ **åˆ†ã‘ã¦èª¬æ˜**ã§ãã‚‹ ([Microsoft Learn][1])
* [ ] å¤–éƒ¨å…¬é–‹ã‚¤ãƒ™ãƒ³ãƒˆã« **EventId / Type / Version / Time** ã‚’å…¥ã‚ŒãŸğŸ“¨
* [ ] å¤–éƒ¨ã®ã‚¯ã‚»ã¯ **ACLã§å¸å**ã™ã‚‹è¨­è¨ˆã«ã—ãŸ ([Microsoft Learn][4])
* [ ] Outboxã«ä¿å­˜ã—ã¦ã‹ã‚‰é€ã‚‹æµã‚Œã‚’æã‘ã‚‹ ([Microsoft Learn][5])
* [ ] Sagaã§ **è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³**ã‚’è¨€èªåŒ–ã§ãã‚‹ ([Microsoft Learn][6])

---

## 12. ã‚ˆãã‚ã‚‹äº‹æ•…ã‚ã‚‹ã‚ã‚‹ğŸ˜‡ğŸ’¥ï¼ˆå…ˆã«æ½°ãï¼ï¼‰

* **ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãã®ã¾ã¾å¤–éƒ¨ã«æµã™** â†’ å¾Œã‹ã‚‰å†…éƒ¨å¤‰æ›´ã§ããšåœ°ç„ğŸ“›
* **ã‚¤ãƒ™ãƒ³ãƒˆã«ãƒ¢ãƒ‡ãƒ«ä¸¸ã”ã¨å…¥ã‚Œã‚‹** â†’ ä¾å­˜ãŒå¢—ãˆã¦ç ´ç¶»ğŸ˜ğŸ’¦
* **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãªã—** â†’ å¤‰æ›´ãŒæ¥ãŸç¬é–“ã«å…¨å“¡ãŒå›°ã‚‹ğŸ§¨
* **é‡è¤‡å¯¾ç­–ãªã—** â†’ äºŒé‡èª²é‡‘ãƒ»äºŒé‡ä»˜ä¸ãƒ»äºŒé‡ãƒ¡ãƒ¼ãƒ«ğŸ“¨ğŸ“¨ğŸ“¨
* **Sagaã®è£œå„Ÿã‚’è€ƒãˆãªã„** â†’ â€œé€”ä¸­ã¾ã§æˆåŠŸâ€ã®ã¾ã¾å–ã‚Šæ®‹ã•ã‚Œã‚‹ğŸ˜±

---

## ä»˜éŒ²ï¼š2026å¹´æ™‚ç‚¹ã®C#/.NETã®ç›®å®‰ğŸ“ŒğŸªŸ

* **.NET 10** ã¯ **2025-11-11** ã«ãƒªãƒªãƒ¼ã‚¹ã€LTSã§ **2028-11-14** ã¾ã§ã‚µãƒãƒ¼ãƒˆã€æœ€æ–°ãƒ‘ãƒƒãƒã¯ **10.0.2ï¼ˆ2026-01-13ï¼‰** ([Microsoft][7])
* **C# 14** ã¯ **2025å¹´11æœˆãƒªãƒªãƒ¼ã‚¹**ã§ã€**.NET 10 ä»¥é™ã§ã‚µãƒãƒ¼ãƒˆ** ([Microsoft Learn][8])

[1]: https://learn.microsoft.com/en-us/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/domain-events-design-implementation?utm_source=chatgpt.com "Domain events: Design and implementation - .NET"
[2]: https://learn.microsoft.com/en-us/dotnet/architecture/microservices/multi-container-microservice-net-applications/integration-event-based-microservice-communications?utm_source=chatgpt.com "Implementing event-based communication between ..."
[3]: https://github.com/cloudevents/spec?utm_source=chatgpt.com "CloudEvents Specification"
[4]: https://learn.microsoft.com/en-us/azure/architecture/patterns/anti-corruption-layer?utm_source=chatgpt.com "Anti-corruption Layer pattern - Azure Architecture Center"
[5]: https://learn.microsoft.com/en-us/azure/architecture/databases/guide/transactional-outbox-cosmos?utm_source=chatgpt.com "Transactional Outbox pattern with Azure Cosmos DB"
[6]: https://learn.microsoft.com/en-us/azure/architecture/patterns/saga?utm_source=chatgpt.com "Saga Design Pattern - Azure Architecture Center"
[7]: https://dotnet.microsoft.com/en-us/platform/support/policy/dotnet-core ".NET and .NET Core official support policy | .NET"
[8]: https://learn.microsoft.com/en-us/dotnet/csharp/whats-new/csharp-version-history "The history of C# | Microsoft Learn"
